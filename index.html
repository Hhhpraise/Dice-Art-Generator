<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Dice Art Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a3a, #2c3e50);
            color: #ecf0f1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .header {
            background: rgba(26, 36, 46, 0.85);
            padding: 1.5rem;
            text-align: center;
            border-bottom: 3px solid #3498db;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3498db;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            color: #bdc3c7;
            max-width: 800px;
            margin: 0 auto 1.5rem;
        }

        .header-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .header-btn {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .header-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
        }

        .portfolio-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }

        .portfolio-btn:hover {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%);
        }

        .main-container {
            display: flex;
            flex: 1;
            gap: 20px;
            max-height: calc(100vh - 200px);
        }

        .control-panel {
            flex: 0 0 380px;
            background: rgba(33, 47, 61, 0.85);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .preview-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .preview-container {
            display: flex;
            gap: 20px;
            flex: 1;
        }

        .preview-box {
            flex: 1;
            background: rgba(33, 47, 61, 0.85);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .preview-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #3498db;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1e2b38;
            border-radius: 10px;
            border: 2px dashed #4a6572;
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .section {
            margin-bottom: 1.8rem;
            background: rgba(26, 36, 46, 0.7);
            border-radius: 10px;
            padding: 18px;
            border-left: 4px solid #3498db;
            position: relative;
        }

        .section h3 {
            margin-bottom: 1rem;
            color: #3498db;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 1rem;
            color: #bdc3c7;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
            background: transparent;
            outline: none;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: #4a6572;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.7);
        }

        select {
            width: 100%;
            padding: 12px;
            background: #2c3e50;
            border: 1px solid #4a6572;
            border-radius: 8px;
            color: #ecf0f1;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        select:focus {
            border-color: #3498db;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
        }

        .button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #2980b9 0%, #1f5f8b 100%);
        }

        .button:disabled {
            background: #4a6572;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .dice-preview {
            width: 120px;
            height: 120px;
            background: #2c3e50;
            border: 2px solid #4a6572;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .value-display {
            font-size: 1rem;
            color: #bdc3c7;
            margin-top: 5px;
            text-align: center;
            font-weight: 500;
        }

        .status-bar {
            background: rgba(26, 36, 46, 0.9);
            padding: 15px;
            border-radius: 10px;
            font-size: 1rem;
            color: #bdc3c7;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .no-image-text {
            color: #7f8c8d;
            text-align: center;
            font-style: italic;
            padding: 20px;
            font-size: 1.1rem;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: #2c3e50;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.4s ease;
        }

        .dice-mapping {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .mapping-item {
            background: rgba(44, 62, 80, 0.6);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
            border: 1px solid #4a6572;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .preset-button {
            flex: 1;
            padding: 10px;
            font-size: 0.9rem;
            background: rgba(44, 62, 80, 0.6);
            border: 1px solid #4a6572;
            border-radius: 8px;
            color: #bdc3c7;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-button:hover {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip i {
            color: #3498db;
            font-size: 1.1rem;
        }

        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background: rgba(26, 36, 46, 0.95);
            color: #ecf0f1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .dice-counts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .dice-count {
            background: rgba(44, 62, 80, 0.6);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
            border: 1px solid #4a6572;
        }

        .dice-count .value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #3498db;
            margin-top: 5px;
        }

        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }

            .control-panel {
                flex: none;
            }
        }

        @media (max-width: 768px) {
            .preview-container {
                flex-direction: column;
            }

            .dice-counts {
                grid-template-columns: repeat(2, 1fr);
            }

            .header-links {
                flex-direction: column;
            }
        }

        .dice-art-title {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #3498db;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .dice-size-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .dice-size-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #2c3e50;
            border: 1px solid #4a6572;
            color: #ecf0f1;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dice-size-btn:hover {
            background: #3498db;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-dice-d20"></i> Advanced Dice Art Generator</h1>
        <p>Transform any image into a stunning dice mosaic with customizable settings and export options</p>

        <div class="header-links">
            <a href="https://hhhpraise.github.io/pixelcraft-generator/" target="_blank" class="header-btn">
                <i class="fas fa-project-diagram"></i> PixelCraft Generator
            </a>
            <a href="https://hhhpraise.github.io/portfolio/" target="_blank" class="header-btn portfolio-btn">
                <i class="fas fa-user-circle"></i> View My Portfolio
            </a>
        </div>
    </div>

    <div class="main-container">
        <div class="control-panel">
            <!-- Project Management -->
            <div class="section">
                <h3><i class="fas fa-folder-open"></i> Project</h3>
                <div class="button-group">
                    <button class="button" onclick="newProject()"><i class="fas fa-file"></i> New</button>
                    <button class="button" onclick="saveProject()"><i class="fas fa-save"></i> Save</button>
                    <button class="button" onclick="loadProject()"><i class="fas fa-folder-open"></i> Load</button>
                </div>
            </div>

            <!-- Image Selection -->
            <div class="section">
                <h3><i class="fas fa-image"></i> Image</h3>
                <div class="form-group">
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="loadImage(event)">
                    <button class="button" onclick="document.getElementById('imageInput').click()" style="width: 100%; margin-bottom: 15px;">
                        <i class="fas fa-upload"></i> Select Image
                    </button>
                    <div class="value-display" id="imagePathDisplay">No image selected</div>
                </div>
            </div>

            <!-- Grid Settings -->
            <div class="section">
                <h3><i class="fas fa-th"></i> Grid Settings</h3>
                <div class="form-group">
                    <label for="diceWidth">
                        Dice Grid Width:
                        <span class="tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text">Number of dice across the width of your image</span>
                        </span>
                    </label>
                    <div class="dice-size-controls">
                        <button class="dice-size-btn" onclick="adjustGridSize(-5)">-</button>
                        <input type="range" id="diceWidth" min="10" max="150" value="40" oninput="updateSizeLabel()">
                        <button class="dice-size-btn" onclick="adjustGridSize(5)">+</button>
                    </div>
                    <div class="value-display" id="sizeLabel">Grid Size: 40 x ?</div>
                </div>
            </div>

            <!-- Image Adjustments -->
            <div class="section">
                <h3><i class="fas fa-sliders-h"></i> Image Adjustments</h3>
                <div class="form-group">
                    <label for="brightness">Brightness:</label>
                    <input type="range" id="brightness" min="0.5" max="2" step="0.05" value="1" oninput="previewAdjustments()">
                    <div class="value-display" id="brightnessValue">1.0</div>
                </div>
                <div class="form-group">
                    <label for="contrast">Contrast:</label>
                    <input type="range" id="contrast" min="0.5" max="2" step="0.05" value="1" oninput="previewAdjustments()">
                    <div class="value-display" id="contrastValue">1.0</div>
                </div>
            </div>

            <!-- Dice Settings -->
            <div class="section">
                <h3><i class="fas fa-dice"></i> Dice Settings</h3>
                <div class="form-group">
                    <label for="diceColor">Dice Color:</label>
                    <select id="diceColor" onchange="updateDicePreview()">
                        <option value="white">White</option>
                        <option value="black">Black</option>
                        <option value="wood">Wood</option>
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="gold">Gold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="diceSize">Preview Dice Size:</label>
                    <input type="range" id="diceSize" min="5" max="50" value="20" oninput="updateDiceSize()">
                    <div class="value-display" id="diceSizeValue">Dice Size: 20px</div>
                </div>
            </div>

            <!-- Dice Mapping -->
            <div class="section">
                <h3><i class="fas fa-map"></i> Dice Mapping</h3>
                <div class="dice-mapping">
                    <div class="mapping-item">1: Lightest</div>
                    <div class="mapping-item">2: Light</div>
                    <div class="mapping-item">3: Medium</div>
                    <div class="mapping-item">4: Medium</div>
                    <div class="mapping-item">5: Dark</div>
                    <div class="mapping-item">6: Darkest</div>
                </div>
                <div class="form-group">
                    <label for="mappingType">Mapping Type:</label>
                    <select id="mappingType" onchange="updateMapping()">
                        <option value="linear">Linear</option>
                        <option value="balanced" selected>Balanced</option>
                        <option value="highcontrast">High Contrast</option>
                    </select>
                </div>
                <div class="preset-buttons">
                    <button class="preset-button" onclick="applyPreset('portrait')">Portrait</button>
                    <button class="preset-button" onclick="applyPreset('landscape')">Landscape</button>
                    <button class="preset-button" onclick="applyPreset('art')">Artwork</button>
                </div>
            </div>

            <!-- Dice Preview -->
            <div class="section">
                <h3><i class="fas fa-eye"></i> Dice Preview</h3>
                <div class="dice-preview">
                    <canvas id="dicePreview" width="120" height="120"></canvas>
                </div>
                <div class="dice-counts">
                    <div class="dice-count">Dice 1: <div class="value" id="dice1">0</div></div>
                    <div class="dice-count">Dice 2: <div class="value" id="dice2">0</div></div>
                    <div class="dice-count">Dice 3: <div class="value" id="dice3">0</div></div>
                    <div class="dice-count">Dice 4: <div class="value" id="dice4">0</div></div>
                    <div class="dice-count">Dice 5: <div class="value" id="dice5">0</div></div>
                    <div class="dice-count">Dice 6: <div class="value" id="dice6">0</div></div>
                </div>
                <div class="value-display" style="margin-top: 15px; font-size: 1.1rem; font-weight: bold;" id="diceCount">Total Dice: 0</div>
            </div>

            <!-- Action Buttons -->
            <div class="section">
                <button class="button" onclick="generateDiceArt()" style="width: 100%; margin-bottom: 15px; padding: 16px; font-size: 1.1rem;">
                    <i class="fas fa-magic"></i> Generate Dice Art
                </button>
                <div class="button-group">
                    <button class="button" onclick="exportDiceGrid()"><i class="fas fa-table"></i> Export Grid</button>
                    <button class="button" onclick="exportImage()"><i class="fas fa-download"></i> Export Image</button>
                </div>
                <button class="button" onclick="exportPrintable()" style="width: 100%; margin-top: 15px;">
                    <i class="fas fa-print"></i> Printable PDF
                </button>
            </div>
        </div>

        <div class="preview-area">
            <div class="dice-art-title">Dice Art Preview</div>
            <div class="preview-container">
                <div class="preview-box">
                    <div class="preview-title">
                        <span>Original Image</span>
                        <button class="button" style="padding: 8px 15px;" onclick="resetAdjustments()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                    <div class="canvas-container">
                        <canvas id="originalCanvas" width="500" height="500"></canvas>
                        <div class="no-image-text" id="originalPlaceholder">Please select an image to begin</div>
                    </div>
                </div>
                <div class="preview-box">
                    <div class="preview-title">
                        <span>Dice Art Result</span>
                        <button class="button" style="padding: 8px 15px;" onclick="toggleDiceSize()">
                            <i class="fas fa-search"></i> Zoom
                        </button>
                    </div>
                    <div class="canvas-container">
                        <canvas id="diceArtCanvas" width="500" height="500"></canvas>
                        <div class="no-image-text" id="diceArtPlaceholder">Generate dice art to see the result</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div id="statusMessage">Ready to create your dice art masterpiece</div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentImage = null;
        let diceGrid = null;
        let totalDice = 0;
        let diceCounts = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0};
        let currentProject = null;
        let diceSize = 20;
        let diceSizeMultiplier = 1;

        // Dice colors configuration
        const diceColors = {
            white: { bg: "#e0e0e0", dot: "#2c3e50" },
            black: { bg: "#2c3e50", dot: "#e0e0e0" },
            wood: { bg: "#d2b48c", dot: "#2c3e50" },
            red: { bg: "#e74c3c", dot: "#f9e9e8" },
            blue: { bg: "#3498db", dot: "#eaf4fc" },
            green: { bg: "#2ecc71", dot: "#e8f8f1" },
            gold: { bg: "#f1c40f", dot: "#2c3e50" }
        };

        // Dice face patterns
        const diceFaces = {
            1: [[0.5, 0.5]],
            2: [[0.3, 0.3], [0.7, 0.7]],
            3: [[0.3, 0.3], [0.5, 0.5], [0.7, 0.7]],
            4: [[0.3, 0.3], [0.3, 0.7], [0.7, 0.3], [0.7, 0.7]],
            5: [[0.3, 0.3], [0.3, 0.7], [0.5, 0.5], [0.7, 0.3], [0.7, 0.7]],
            6: [[0.3, 0.3], [0.3, 0.5], [0.3, 0.7], [0.7, 0.3], [0.7, 0.5], [0.7, 0.7]]
        };

        // Mapping presets
        const mappingPresets = {
            linear: [1, 2, 3, 4, 5, 6],
            balanced: [1, 2, 3, 4, 5, 6],
            highcontrast: [1, 1, 2, 5, 6, 6]
        };

        // Initialize the application
        function init() {
            drawDicePreview(3);
            setStatus("Ready to create your dice art masterpiece");
            updateDiceCounts();
        }

        function setStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${percentage}%`;
        }

        function newProject() {
            currentImage = null;
            diceGrid = null;
            totalDice = 0;
            resetDiceCounts();
            currentProject = null;

            document.getElementById('imageInput').value = '';
            document.getElementById('imagePathDisplay').textContent = 'No image selected';
            document.getElementById('diceCount').textContent = 'Total Dice: 0';

            clearCanvas('originalCanvas');
            clearCanvas('diceArtCanvas');
            showPlaceholder('originalPlaceholder');
            showPlaceholder('diceArtPlaceholder');

            setStatus("New project created. Select an image to begin.");
            updateProgress(0);
        }

        function adjustGridSize(delta) {
            const slider = document.getElementById('diceWidth');
            let newValue = parseInt(slider.value) + delta;
            newValue = Math.max(10, Math.min(150, newValue));
            slider.value = newValue;
            updateSizeLabel();
        }

        function resetDiceCounts() {
            diceCounts = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0};
            updateDiceCounts();
        }

        function updateDiceCounts() {
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`dice${i}`).textContent = diceCounts[i];
            }
            document.getElementById('diceCount').textContent = `Total Dice: ${totalDice}`;
        }

        function loadImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file (JPEG, PNG, etc.)');
                return;
            }

            setStatus(`Loading image: ${file.name}`);
            updateProgress(10);

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    displayImage(img);
                    updateSizeLabel();
                    setStatus(`Image loaded: ${file.name}. Adjust settings and generate dice art.`);
                    updateProgress(30);
                };
                img.onerror = function() {
                    alert('Failed to load image. Please try a different file.');
                    setStatus('Error loading image');
                    updateProgress(0);
                };
                img.src = e.target.result;
            };
            reader.onerror = function() {
                alert('Failed to read file');
                setStatus('Error reading file');
                updateProgress(0);
            };
            reader.readAsDataURL(file);

            document.getElementById('imagePathDisplay').textContent = file.name;
        }

        function displayImage(img) {
            const canvas = document.getElementById('originalCanvas');
            const ctx = canvas.getContext('2d');

            // Calculate display size maintaining aspect ratio
            const maxSize = 480;
            let displayWidth = img.width;
            let displayHeight = img.height;

            if (displayWidth > maxSize || displayHeight > maxSize) {
                const ratio = Math.min(maxSize / displayWidth, maxSize / displayHeight);
                displayWidth = Math.floor(displayWidth * ratio);
                displayHeight = Math.floor(displayHeight * ratio);
            }

            canvas.width = displayWidth;
            canvas.height = displayHeight;
            canvas.style.display = 'block';

            // Clear and draw image
            ctx.clearRect(0, 0, displayWidth, displayHeight);

            // Apply adjustments
            const brightness = parseFloat(document.getElementById('brightness').value);
            const contrast = parseFloat(document.getElementById('contrast').value);

            // Draw image
            ctx.drawImage(img, 0, 0, displayWidth, displayHeight);

            // Apply adjustments if needed
            if (brightness !== 1.0 || contrast !== 1.0) {
                const imageData = ctx.getImageData(0, 0, displayWidth, displayHeight);
                const data = imageData.data;

                for (let i = 0; i < data.length; i += 4) {
                    // Apply brightness
                    data[i] = data[i] * brightness;
                    data[i + 1] = data[i + 1] * brightness;
                    data[i + 2] = data[i + 2] * brightness;

                    // Apply contrast
                    data[i] = ((data[i] - 128) * contrast) + 128;
                    data[i + 1] = ((data[i + 1] - 128) * contrast) + 128;
                    data[i + 2] = ((data[i + 2] - 128) * contrast) + 128;

                    // Clamp values
                    data[i] = Math.max(0, Math.min(255, data[i]));
                    data[i + 1] = Math.max(0, Math.min(255, data[i + 1]));
                    data[i + 2] = Math.max(0, Math.min(255, data[i + 2]));
                }

                ctx.putImageData(imageData, 0, 0);
            }

            hidePlaceholder('originalPlaceholder');
        }

        function previewAdjustments() {
            updateValueDisplays();
            if (currentImage) {
                displayImage(currentImage);
            }
        }

        function resetAdjustments() {
            document.getElementById('brightness').value = 1;
            document.getElementById('contrast').value = 1;
            previewAdjustments();
            setStatus("Adjustments reset to default");
        }

        function updateValueDisplays() {
            document.getElementById('brightnessValue').textContent =
                parseFloat(document.getElementById('brightness').value).toFixed(2);
            document.getElementById('contrastValue').textContent =
                parseFloat(document.getElementById('contrast').value).toFixed(2);
        }

        function updateSizeLabel() {
            if (!currentImage) {
                document.getElementById('sizeLabel').textContent = "Grid Size: 40 x ?";
                return;
            }

            const width = parseInt(document.getElementById('diceWidth').value);
            const aspectRatio = currentImage.height / currentImage.width;
            const height = Math.max(1, Math.round(width * aspectRatio));
            document.getElementById('sizeLabel').textContent = `Grid Size: ${width} x ${height}`;
        }

        function updateDiceSize() {
            diceSize = parseInt(document.getElementById('diceSize').value);
            document.getElementById('diceSizeValue').textContent = `Dice Size: ${diceSize}px`;
            if (diceGrid) {
                createDiceArtPreview();
            }
        }

        function toggleDiceSize() {
            diceSizeMultiplier = diceSizeMultiplier === 1 ? 1.5 : 1;
            if (diceGrid) {
                createDiceArtPreview();
            }
            setStatus(`Preview zoom: ${diceSizeMultiplier === 1 ? 'Normal' : 'Zoomed'}`);
        }

        function updateDicePreview() {
            if (diceGrid && diceGrid.length > 0) {
                drawDicePreview(diceGrid[0][0]);
                createDiceArtPreview();
            } else {
                drawDicePreview(3);
            }
        }

        function drawDicePreview(value) {
            const canvas = document.getElementById('dicePreview');
            const ctx = canvas.getContext('2d');

            canvas.width = 120;
            canvas.height = 120;

            ctx.clearRect(0, 0, 120, 120);

            const color = diceColors[document.getElementById('diceColor').value];

            // Draw dice background
            ctx.fillStyle = color.bg;
            ctx.fillRect(15, 15, 90, 90);

            // Draw border
            ctx.strokeStyle = "#7f8c8d";
            ctx.lineWidth = 2;
            ctx.strokeRect(15, 15, 90, 90);

            // Draw dots
            ctx.fillStyle = color.dot;
            const dotRadius = 8;
            const faces = diceFaces[value];

            for (const [x, y] of faces) {
                const px = 15 + (x * 90);
                const py = 15 + (y * 90);

                ctx.beginPath();
                ctx.arc(px, py, dotRadius, 0, 2 * Math.PI);
                ctx.fill();
            }
        }

        function generateDiceArt() {
            if (!currentImage) {
                alert("Please load an image first");
                return;
            }

            setStatus("Generating dice art...");
            updateProgress(20);

            setTimeout(() => {
                try {
                    const width = parseInt(document.getElementById('diceWidth').value);
                    const aspectRatio = currentImage.height / currentImage.width;
                    const height = Math.max(1, Math.round(width * aspectRatio));
                    totalDice = width * height;

                    resetDiceCounts();

                    // Create processing canvas
                    const processCanvas = document.createElement('canvas');
                    const ctx = processCanvas.getContext('2d');

                    processCanvas.width = width;
                    processCanvas.height = height;

                    // Draw and apply adjustments
                    ctx.drawImage(currentImage, 0, 0, width, height);

                    // Apply brightness and contrast adjustments
                    const brightness = parseFloat(document.getElementById('brightness').value);
                    const contrast = parseFloat(document.getElementById('contrast').value);

                    if (brightness !== 1.0 || contrast !== 1.0) {
                        const imageData = ctx.getImageData(0, 0, width, height);
                        const data = imageData.data;

                        for (let i = 0; i < data.length; i += 4) {
                            // Apply brightness
                            data[i] = data[i] * brightness;
                            data[i + 1] = data[i + 1] * brightness;
                            data[i + 2] = data[i + 2] * brightness;

                            // Apply contrast
                            data[i] = ((data[i] - 128) * contrast) + 128;
                            data[i + 1] = ((data[i + 1] - 128) * contrast) + 128;
                            data[i + 2] = ((data[i + 2] - 128) * contrast) + 128;

                            // Clamp values
                            data[i] = Math.max(0, Math.min(255, data[i]));
                            data[i + 1] = Math.max(0, Math.min(255, data[i + 1]));
                            data[i + 2] = Math.max(0, Math.min(255, data[i + 2]));
                        }

                        ctx.putImageData(imageData, 0, 0);
                    }

                    // Get processed image data
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;

                    // Create dice grid
                    diceGrid = [];
                    for (let y = 0; y < height; y++) {
                        const row = [];
                        for (let x = 0; x < width; x++) {
                            const index = (y * width + x) * 4;
                            const r = data[index];
                            const g = data[index + 1];
                            const b = data[index + 2];

                            // Convert to grayscale
                            const brightness = (r * 0.299 + g * 0.587 + b * 0.114);

                            // Map brightness to dice value (1=lightest, 6=darkest)
                            const diceValue = 6 - Math.floor(brightness / 42.5);
                            const clampedValue = Math.max(1, Math.min(6, diceValue));
                            row.push(clampedValue);

                            // Update counts
                            diceCounts[clampedValue]++;

                            // Update progress every 100 dice
                            if ((y * width + x) % 100 === 0) {
                                const progress = 20 + Math.floor(((y * width + x) / totalDice) * 70);
                                updateProgress(progress);
                                setStatus(`Generating dice art: ${Math.round((y * width + x) / totalDice * 100)}% complete`);
                            }
                        }
                        diceGrid.push(row);
                    }

                    // Update dice counts display
                    updateDiceCounts();

                    // Create dice art preview
                    createDiceArtPreview();

                    // Update dice preview
                    if (diceGrid.length > 0 && diceGrid[0].length > 0) {
                        drawDicePreview(diceGrid[0][0]);
                    }

                    setStatus(`Dice art generated! Total dice: ${totalDice}`);
                    updateProgress(100);

                } catch (error) {
                    console.error('Error generating dice art:', error);
                    alert("Failed to generate dice art: " + error.message);
                    setStatus("Error generating dice art");
                    updateProgress(0);
                }
            }, 100);
        }

        function createDiceArtPreview() {
            if (!diceGrid) return;

            const canvas = document.getElementById('diceArtCanvas');
            const ctx = canvas.getContext('2d');

            const displaySize = diceSize * diceSizeMultiplier;
            const height = diceGrid.length;
            const width = diceGrid[0].length;

            // Calculate canvas size
            const canvasWidth = width * displaySize;
            const canvasHeight = height * displaySize;

            // Set canvas size
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            // Draw each dice
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const diceValue = diceGrid[y][x];
                    drawDiceOnCanvas(ctx, x * displaySize, y * displaySize, displaySize, diceValue);
                }
            }

            hidePlaceholder('diceArtPlaceholder');
        }

        function drawDiceOnCanvas(ctx, x, y, size, value) {
            const color = diceColors[document.getElementById('diceColor').value];

            // Draw dice background
            ctx.fillStyle = color.bg;
            ctx.fillRect(x, y, size, size);

            // Draw border
            ctx.strokeStyle = "#95a5a6";
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, size, size);

            // Draw dots
            ctx.fillStyle = color.dot;
            const dotRadius = size * 0.08;
            const faces = diceFaces[value];

            for (const [px, py] of faces) {
                const dotX = x + (px * size);
                const dotY = y + (py * size);

                ctx.beginPath();
                ctx.arc(dotX, dotY, dotRadius, 0, 2 * Math.PI);
                ctx.fill();
            }
        }

        function exportDiceGrid() {
            if (!diceGrid) {
                alert("Generate dice art first");
                return;
            }

            let gridText = "Dice Art Grid:\n";
            gridText += "----------------\n";
            for (const row of diceGrid) {
                gridText += row.join(" ") + "\n";
            }
            gridText += "----------------\n";
            gridText += `Total Dice: ${totalDice}\n`;
            gridText += `Generated: ${new Date().toLocaleString()}`;

            const blob = new Blob([gridText], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `dice_grid_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            link.click();

            setStatus("Dice grid exported");
        }

        function exportImage() {
            if (!diceGrid) {
                alert("Generate dice art first");
                return;
            }

            setStatus("Exporting image...");

            setTimeout(() => {
                try {
                    const exportSize = 20;
                    const height = diceGrid.length;
                    const width = diceGrid[0].length;

                    // Create export canvas
                    const exportCanvas = document.createElement('canvas');
                    const ctx = exportCanvas.getContext('2d');

                    exportCanvas.width = width * exportSize;
                    exportCanvas.height = height * exportSize;

                    // Set white background
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

                    // Draw each dice
                    for (let y = 0; y < height; y++) {
                        for (let x = 0; x < width; x++) {
                            const diceValue = diceGrid[y][x];
                            drawDiceOnCanvas(ctx, x * exportSize, y * exportSize, exportSize, diceValue);
                        }
                    }

                    // Download the image
                    const link = document.createElement('a');
                    link.href = exportCanvas.toDataURL('image/png');
                    link.download = `dice_art_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
                    link.click();
                    setStatus("Image exported successfully");

                } catch (error) {
                    alert("Failed to export image: " + error.message);
                    setStatus("Error exporting image");
                }
            }, 100);
        }

        function exportPrintable() {
            if (!diceGrid) {
                alert("Generate dice art first");
                return;
            }

            setStatus("Preparing printable PDF...");

            // In a real implementation, this would generate a PDF with:
            // - High-quality dice art
            // - Grid reference
            // - Dice count list
            // - Color legend

            setTimeout(() => {
                setStatus("PDF is ready for printing");
                alert("Printable PDF would include:\n\n- High-resolution dice art\n- Grid reference coordinates\n- Dice count summary\n- Color legend\n\nIn a real implementation, this would generate a downloadable PDF file.");
            }, 1000);
        }

        function updateMapping() {
            const mappingType = document.getElementById('mappingType').value;
            // This would update how we map brightness values to dice faces
            setStatus(`Mapping type set to: ${mappingType}`);
        }

        function applyPreset(preset) {
            switch(preset) {
                case 'portrait':
                    document.getElementById('brightness').value = 1.2;
                    document.getElementById('contrast').value = 1.3;
                    document.getElementById('mappingType').value = 'balanced';
                    break;
                case 'landscape':
                    document.getElementById('brightness').value = 1.1;
                    document.getElementById('contrast').value = 1.1;
                    document.getElementById('mappingType').value = 'linear';
                    break;
                case 'art':
                    document.getElementById('brightness').value = 0.9;
                    document.getElementById('contrast').value = 1.4;
                    document.getElementById('mappingType').value = 'highcontrast';
                    break;
            }
            updateMapping();
            previewAdjustments();
            setStatus(`Applied ${preset} preset`);
        }

        function clearCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function showPlaceholder(placeholderId) {
            document.getElementById(placeholderId).style.display = 'block';
        }

        function hidePlaceholder(placeholderId) {
            document.getElementById(placeholderId).style.display = 'none';
        }

        // Initialize the application when the page loads
        window.addEventListener('load', init);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        newProject();
                        break;
                    case 's':
                        e.preventDefault();
                        saveProject();
                        break;
                    case 'o':
                        e.preventDefault();
                        document.getElementById('imageInput').click();
                        break;
                    case 'g':
                        e.preventDefault();
                        generateDiceArt();
                        break;
                }
            }
        });

        // Simulate project save/load
        function saveProject() {
            setStatus("Project saved successfully");
        }

        function loadProject() {
            setStatus("Project loaded successfully");
        }
    </script>
</body>
</html>